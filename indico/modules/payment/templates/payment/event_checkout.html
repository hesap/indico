<p>
    You need to pay {{ format_currency(amount, currency, locale=session.lang) }} for your registration.
    {% if force_plugin %}
        You can pay using <strong>{{ force_plugin[1].get_method_name(event) }}</strong>.
    {% else %}
        Please select a payment method below to see the final price.
    {% endif %}
</p>
{% if not force_plugin %}
    <select id="payment-method">
        <option value="">{% trans %}Please choose an option{% endtrans %}</option>
        {% for name, plugin in plugins %}
            <option value="{{ name }}">{{ plugin.get_method_name(event) }}</option>
        {% endfor %}
    </select>
{% endif %}

<div id="payment"></div>

<script>
    (function(global) {
        var paymentContainer = $('#payment');
        var paymentMethod = {{ (force_plugin[0] if force_plugin else '') | tojson }};

        // You can use this function if your payment plugin has any dynamic data which affect the displayed information.
        // For example, selecting different credit card types could cause different fees to be applied.
        // Simply call reloadPaymentMethod({your: 'custom data'}) in the payment form template of your plugin and
        // override render_payment_form in the plugin class.
        global.reloadPaymentMethod = function reloadPaymentMethod(extraData) {
            $.ajax({
                url: {{ url_for('.event_payment_form', event, registrant) | tojson }},
                type: 'GET',
                data: $.extend({}, extraData || {}, {
                    method: paymentMethod
                }),
                dataType: 'json',
                complete: IndicoUI.Dialogs.Util.progress(),
                success: function(data) {
                    paymentContainer.html('');
                    if (handleAjaxError(data)) {
                        return;
                    }
                    paymentContainer.html(data.html);
                }
            });
        };

        $('#payment-method').on('change', function() {
            paymentMethod = $(this).val();
            if (!paymentMethod) {
                paymentContainer.html('');
                return;
            }
            reloadPaymentMethod();
        });

        if (paymentMethod) {
            reloadPaymentMethod();
        }
    })(window);
</script>
